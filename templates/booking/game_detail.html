{% extends 'base.html' %}
{% load static %}

{% block title %}{{ game.name }} - Game Details{% endblock %}

{% block extra_css %}
<style>
    .slot-card {
        transition: all 0.3s ease;
        border: 2px solid transparent;
    }
    .slot-card:hover {
        transform: translateY(-2px);
        border-color: #3b82f6;
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    .capacity-indicator {
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }
    .capacity-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
    }
    .capacity-dot.booked {
        background-color: #ef4444;
    }
    .capacity-dot.available {
        background-color: #10b981;
    }
    .date-tab {
        transition: all 0.2s ease;
    }
    .date-tab.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        transform: scale(1.05);
    }
    .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }
    .scrollbar-hide::-webkit-scrollbar {
        display: none;
    }
    
    /* Skeleton loading animation */
    .skeleton {
        animation: skeleton-loading 1s linear infinite alternate;
        background: linear-gradient(90deg, #2d2d2d 25%, #3d3d3d 50%, #2d2d2d 75%);
        background-size: 200% 100%;
    }
    @keyframes skeleton-loading {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }
    
    .fade-in {
        animation: fadeIn 0.3s ease-in;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    /* Loading spinner */
    .loading-spinner {
        display: inline-block;
        width: 40px;
        height: 40px;
        border: 4px solid rgba(255, 255, 255, 0.1);
        border-top-color: #667eea;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    .loading-overlay {
        position: relative;
        min-height: 400px;
    }
    
    .loading-message {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        z-index: 10;
    }
    
    /* Pulse animation for loading text */
    .pulse {
        animation: pulse 1.5s ease-in-out infinite;
    }
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    
    /* Spot selector button styles */
    .spot-selector-btn {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .spot-selector-btn:hover {
        transform: scale(1.05);
    }
    
    .spot-selector-btn.scale-110 {
        transform: scale(1.1);
    }
    
    /* Modal animation */
    #spotSelectionModal {
        animation: modalFadeIn 0.3s ease-out;
    }
    
    @keyframes modalFadeIn {
        from {
            opacity: 0;
            transform: scale(0.95);
        }
        to {
            opacity: 1;
            transform: scale(1);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-gaming-primary via-gaming-secondary to-gaming-accent py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        
        <!-- Back Button -->
        <div class="mb-6">
            <a href="{% url 'home' %}" class="inline-flex items-center text-white hover:text-gaming-highlight transition-colors">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                </svg>
                Back to Home
            </a>
        </div>

        <!-- Game Header -->
        <div class="bg-white/10 backdrop-blur-lg rounded-2xl overflow-hidden border border-white/20 mb-8">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Game Image -->
                <div class="h-80 bg-gradient-to-br from-gaming-highlight/30 to-gaming-accent/30 relative overflow-hidden">
                    {% if game.image %}
                    <img src="{{ game.image.url }}" alt="{{ game.name }}" class="w-full h-full object-cover">
                    {% else %}
                    <div class="flex items-center justify-center h-full">
                        <div class="text-white text-center">
                            <div class="text-8xl mb-4">üéÆ</div>
                            <div class="text-3xl font-bold">{{ game.name }}</div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Booking Type Badge -->
                    <div class="absolute top-4 right-4">
                        {% if game.booking_type == 'HYBRID' %}
                        <span class="bg-green-500/90 backdrop-blur-sm text-white px-4 py-2 rounded-full text-sm font-medium shadow-lg">
                            ü§ù Private + Shared Available
                        </span>
                        {% else %}
                        <span class="bg-blue-500/90 backdrop-blur-sm text-white px-4 py-2 rounded-full text-sm font-medium shadow-lg">
                            üîí Private Booking Only
                        </span>
                        {% endif %}
                    </div>
                </div>

                <!-- Game Info -->
                <div class="p-8">
                    <h1 class="text-4xl font-bold text-white mb-4">{{ game.name }}</h1>
                    <p class="text-gray-300 text-lg mb-6">{{ game.description }}</p>
                    
                    <!-- Game Details Grid -->
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="bg-white/5 rounded-lg p-4 border border-white/10">
                            <div class="text-gray-400 text-sm mb-1">Capacity</div>
                            <div class="text-white text-xl font-bold">{{ game.capacity }} Player{{ game.capacity|pluralize }}</div>
                        </div>
                        
                        <div class="bg-white/5 rounded-lg p-4 border border-white/10">
                            <div class="text-gray-400 text-sm mb-1">Slot Duration</div>
                            <div class="text-white text-xl font-bold">{{ game.slot_duration_minutes }} Minutes</div>
                        </div>
                        
                        <div class="bg-white/5 rounded-lg p-4 border border-white/10">
                            <div class="text-gray-400 text-sm mb-1">Private Price</div>
                            <div class="text-gaming-highlight text-xl font-bold">‚Çπ{{ game.private_price }}</div>
                        </div>
                        
                        {% if game.booking_type == 'HYBRID' %}
                        <div class="bg-white/5 rounded-lg p-4 border border-white/10">
                            <div class="text-gray-400 text-sm mb-1">Shared Price (per person)</div>
                            <div class="text-green-400 text-xl font-bold">‚Çπ{{ game.shared_price }}</div>
                        </div>
                        {% endif %}
                    </div>

                    {% if not is_authenticated %}
                    <!-- Login CTA for non-authenticated users -->
                    <div class="bg-gradient-to-r from-gaming-highlight to-gaming-accent rounded-lg p-4 text-center">
                        <p class="text-white font-semibold mb-3">Login to book this game!</p>
                        <a href="{% url 'authentication:customer_login' %}?next={{ request.path }}" 
                           class="inline-block bg-white text-gaming-primary px-6 py-3 rounded-lg font-semibold hover:bg-gray-100 transition-all">
                            Login Now
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Date Selection -->
        <div class="mb-8">
            <h2 class="text-2xl font-bold text-white mb-4">Select Date</h2>
            <div class="flex space-x-3 overflow-x-auto pb-2 scrollbar-hide">
                {% for date in date_range %}
                <button type="button"
                        onclick="selectDate('{{ date.isoformat }}')" 
                        class="date-tab flex-shrink-0 px-6 py-3 rounded-lg text-center min-w-[120px] transition-all duration-200 {% if date == selected_date %}active text-white shadow-lg{% else %}bg-white/10 text-gray-300 hover:bg-white/20{% endif %} border border-white/20"
                        data-date="{{ date.isoformat }}">
                    <div class="font-semibold">
                        {% if date == today %}Today{% else %}{{ date|date:"M d" }}{% endif %}
                    </div>
                    <div class="text-sm">{{ date|date:"D" }}</div>
                </button>
                {% endfor %}
            </div>
        </div>

        <!-- Available Slots for Selected Date -->
        <div>
            <h2 class="text-2xl font-bold text-white mb-4">
                Available Time Slots - <span id="selectedDateDisplay">{{ selected_date|date:"l, F d, Y" }}</span>
                {% if selected_date == today %}
                <span class="text-sm text-gaming-highlight ml-2">(Today)</span>
                {% endif %}
            </h2>
            
            <!-- Slots Container - Loaded via AJAX -->
            <div id="slotsContainer">
                <!-- Initial Loading State -->
                <div class="loading-overlay">
                    <div class="loading-message fade-in">
                        <div class="loading-spinner mx-auto mb-4"></div>
                        <p class="text-white text-lg font-medium pulse">Loading available slots...</p>
                        <p class="text-gray-400 text-sm mt-2">Fetching the latest availability</p>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- Spot Selection Modal -->
<div id="spotSelectionModal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden flex items-center justify-center p-4" onclick="closeSpotModal(event)">
    <div class="bg-gradient-to-br from-gaming-secondary to-gaming-accent rounded-2xl max-w-md w-full p-8 border border-white/20" onclick="event.stopPropagation()">
        <div class="text-center mb-6">
            <div class="text-6xl mb-4">üéÆ</div>
            <h3 class="text-2xl font-bold text-white mb-2">Select Number of Spots</h3>
            <p class="text-gray-300 text-sm">How many people are joining?</p>
        </div>

        <!-- Spot Selection Grid -->
        <div id="spotSelectionGrid" class="grid grid-cols-4 gap-3 mb-6">
            <!-- Dynamically filled -->
        </div>

        <!-- Total Price Display -->
        <div class="bg-white/10 rounded-lg p-4 mb-6 border border-white/20">
            <div class="flex justify-between items-center">
                <span class="text-gray-300">Total Price:</span>
                <span id="totalPriceDisplay" class="text-gaming-highlight text-2xl font-bold">‚Çπ0</span>
            </div>
            <div class="text-xs text-gray-400 mt-1">
                <span id="spotsSelectedDisplay">0 spot(s)</span> √ó <span id="pricePerSpotDisplay">‚Çπ0</span>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex space-x-3">
            <button onclick="closeSpotModal()" 
                    class="flex-1 bg-white/10 hover:bg-white/20 text-white px-6 py-3 rounded-lg font-medium transition-colors border border-white/20">
                Cancel
            </button>
            <button id="confirmSpotsButton" onclick="confirmSpotSelection()" 
                    class="flex-1 bg-gaming-highlight hover:bg-gaming-highlight/80 text-white px-6 py-3 rounded-lg font-semibold transition-colors shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
                    disabled>
                Confirm Booking
            </button>
        </div>
    </div>
</div>

<script>
// Configuration
const isAuthenticated = '{{ is_authenticated|yesno:"true,false" }}';
const gameId = "{{ game.id }}";
const csrfToken = "{{ csrf_token }}";
let currentDate = "{{ selected_date.isoformat }}";

// Format date display
function formatDateDisplay(dateStr) {
    const date = new Date(dateStr + 'T00:00:00');
    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    return date.toLocaleDateString('en-US', options);
}

// Check if date is today
function isToday(dateStr) {
    const today = new Date();
    const date = new Date(dateStr + 'T00:00:00');
    return date.toDateString() === today.toDateString();
}

// Select date and load slots
function selectDate(dateStr) {
    currentDate = dateStr;
    
    // Update active state on date buttons with smooth transition
    document.querySelectorAll('.date-tab').forEach(btn => {
        if (btn.dataset.date === dateStr) {
            btn.classList.add('active', 'text-white', 'shadow-lg');
            btn.classList.remove('bg-white/10', 'text-gray-300');
            // Add a subtle scale effect for clicked button
            btn.style.transform = 'scale(1.05)';
        } else {
            btn.classList.remove('active', 'text-white', 'shadow-lg');
            btn.classList.add('bg-white/10', 'text-gray-300');
            btn.style.transform = 'scale(1)';
        }
    });
    
    // Update date display
    const displayText = formatDateDisplay(dateStr) + (isToday(dateStr) ? ' <span class="text-sm text-gaming-highlight ml-2">(Today)</span>' : '');
    document.getElementById('selectedDateDisplay').innerHTML = displayText;
    
    // Scroll slots container into view smoothly
    document.getElementById('slotsContainer').scrollIntoView({ 
        behavior: 'smooth', 
        block: 'nearest' 
    });
    
    // Load slots for selected date
    loadSlotsForDate(dateStr);
}

// Load slots via API (OPTIMIZED WITH AJAX)
function loadSlotsForDate(dateStr) {
    const container = document.getElementById('slotsContainer');
    
    // Show beautiful loading spinner with message
    container.innerHTML = `
        <div class="loading-overlay">
            <div class="loading-message fade-in">
                <div class="loading-spinner mx-auto mb-4"></div>
                <p class="text-white text-lg font-medium pulse">Loading slots...</p>
                <p class="text-gray-400 text-sm mt-2">Please wait a moment</p>
            </div>
        </div>
    `;
    
    // Fetch slots from API
    fetch(`/api/games/${gameId}/slots/?date=${dateStr}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to load slots');
            }
            return response.json();
        })
        .then(data => {
            renderSlots(data.slots);
        })
        .catch(error => {
            console.error('Error loading slots:', error);
            showError('Unable to load slots. Please try again.');
        });
}

// Render slots from API data
function renderSlots(slots) {
    const container = document.getElementById('slotsContainer');
    
    if (!slots || slots.length === 0) {
        container.innerHTML = `
            <div class="text-center py-16 bg-white/5 rounded-2xl border border-white/10 fade-in">
                <div class="text-gray-400 text-6xl mb-4">üìÖ</div>
                <p class="text-gray-300 text-lg mb-2">No slots available for this date</p>
                <p class="text-gray-400">Try selecting a different date or check back later</p>
            </div>
        `;
        return;
    }
    
    let html = '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">';
    
    slots.forEach(slot => {
        const availability = slot.availability;
        const bookingOptions = slot.booking_options;
        
        html += `
            <div class="slot-card bg-white/10 backdrop-blur-lg rounded-lg p-5 border border-white/20 fade-in">
                <!-- Time -->
                <div class="flex items-center justify-between mb-3">
                    <div class="text-white font-bold text-lg">
                        ${slot.time_display}
                    </div>
                    <div class="capacity-indicator">
                        ${renderCapacityDots(availability)}
                        <span class="text-xs text-gray-400 ml-1">
                            ${availability.available_spots}/${availability.total_capacity}
                        </span>
                    </div>
                </div>

                <!-- Booking Options -->
                <div class="space-y-2">
                    ${renderBookingOptions(slot, bookingOptions)}
                </div>

                ${availability.available_spots === 0 ? `
                <div class="mt-3 text-center">
                    <span class="inline-block bg-red-500/20 text-red-300 px-3 py-1 rounded-full text-xs font-medium">
                        Fully Booked
                    </span>
                </div>
                ` : ''}
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

// Render capacity indicator dots
function renderCapacityDots(availability) {
    let html = '';
    for (let i = 0; i < availability.total_capacity; i++) {
        const dotClass = i < availability.booked_spots ? 'booked' : 'available';
        html += `<div class="capacity-dot ${dotClass}"></div>`;
    }
    return html;
}

// Render booking options (private/shared)
function renderBookingOptions(slot, options) {
    if (!options || options.length === 0) {
        return '<p class="text-gray-400 text-sm">No booking options available</p>';
    }
    
    let html = '';
    
    options.forEach(option => {
        if (option.type === 'PRIVATE') {
            html += renderPrivateOption(slot, option);
        } else if (option.type === 'SHARED') {
            html += renderSharedOption(slot, option);
        }
    });
    
    return html;
}

// Render private booking option
function renderPrivateOption(slot, option) {
    const disabled = !option.available;
    
    return `
        <div class="bg-blue-500/20 border border-blue-400/30 rounded p-3">
            <div class="flex items-center justify-between mb-2">
                <span class="text-blue-200 font-medium text-sm">üîí Private Booking</span>
                <span class="text-blue-300 font-bold">‚Çπ${option.price}</span>
            </div>
            <div class="text-blue-200 text-xs mb-2">${option.description}</div>
            ${isAuthenticated ? `
                <button onclick="bookSlot('${slot.id}', 'PRIVATE', ${option.capacity})" 
                        ${disabled ? 'disabled' : ''}
                        class="w-full ${disabled ? 'bg-gray-500 cursor-not-allowed' : 'bg-blue-500 hover:bg-blue-600'} text-white px-3 py-2 rounded text-sm font-medium transition-colors">
                    ${disabled ? 'Not Available' : 'Book Private'}
                </button>
            ` : `
                <a href="/accounts/login/?next=${window.location.pathname}" 
                   class="block w-full bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded text-sm font-medium text-center transition-colors">
                    Login to Book
                </a>
            `}
        </div>
    `;
}

// Render shared booking option
function renderSharedOption(slot, option) {
    const disabled = !option.available;
    
    return `
        <div class="bg-green-500/20 border border-green-400/30 rounded p-3">
            <div class="flex items-center justify-between mb-2">
                <span class="text-green-200 font-medium text-sm">ü§ù Shared Booking</span>
                <span class="text-green-300 font-bold">‚Çπ${option.price_per_spot}/person</span>
            </div>
            <div class="text-green-200 text-xs mb-2">${option.description}</div>
            ${isAuthenticated ? `
                <button onclick="showSpotSelectionModal('${slot.id}', ${option.available_spots}, ${option.price_per_spot}, ${option.max_spots_per_booking || 4})" 
                        ${disabled ? 'disabled' : ''}
                        class="w-full ${disabled ? 'bg-gray-500 cursor-not-allowed' : 'bg-green-500 hover:bg-green-600'} text-white px-3 py-2 rounded text-sm font-medium transition-colors">
                    ${disabled ? 'Not Available' : 'Book Shared'}
                </button>
            ` : `
                <a href="/accounts/login/?next=${window.location.pathname}" 
                   class="block w-full bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded text-sm font-medium text-center transition-colors">
                    Login to Book
                </a>
            `}
        </div>
    `;
}

// Show error message
function showError(message) {
    const container = document.getElementById('slotsContainer');
    container.innerHTML = `
        <div class="text-center py-16 bg-red-500/10 rounded-2xl border border-red-500/30 fade-in">
            <div class="text-red-400 text-6xl mb-4">‚ö†Ô∏è</div>
            <p class="text-red-300 text-lg mb-2">${message}</p>
            <button onclick="loadSlotsForDate(currentDate)" 
                    class="mt-4 bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-lg transition-colors">
                Try Again
            </button>
        </div>
    `;
}

{% if is_authenticated %}
// Spot selection modal variables
let selectedSlotId = null;
let selectedSpots = 0;
let pricePerSpot = 0;
let maxSpots = 0;

// Show spot selection modal
function showSpotSelectionModal(slotId, availableSpots, spotPrice, maxSpotsPerBooking) {
    selectedSlotId = slotId;
    pricePerSpot = spotPrice;
    maxSpots = Math.min(availableSpots, maxSpotsPerBooking);
    selectedSpots = 0;
    
    // Build spot selection grid
    const grid = document.getElementById('spotSelectionGrid');
    grid.innerHTML = '';
    
    for (let i = 1; i <= maxSpots; i++) {
        const button = document.createElement('button');
        button.className = 'spot-selector-btn bg-white/10 hover:bg-white/20 text-white rounded-lg py-4 font-bold text-lg transition-all border-2 border-white/20 hover:border-gaming-highlight';
        button.textContent = i;
        button.onclick = () => selectNumberOfSpots(i);
        grid.appendChild(button);
    }
    
    // Update displays
    updatePriceDisplay();
    
    // Show modal
    document.getElementById('spotSelectionModal').classList.remove('hidden');
    document.getElementById('spotSelectionModal').classList.add('flex');
}

// Select number of spots
function selectNumberOfSpots(spots) {
    selectedSpots = spots;
    
    // Update button states
    const buttons = document.querySelectorAll('.spot-selector-btn');
    buttons.forEach((btn, index) => {
        if (index + 1 === spots) {
            btn.classList.add('bg-gaming-highlight', 'border-gaming-highlight', 'scale-110', 'shadow-lg');
            btn.classList.remove('bg-white/10', 'border-white/20');
        } else {
            btn.classList.remove('bg-gaming-highlight', 'border-gaming-highlight', 'scale-110', 'shadow-lg');
            btn.classList.add('bg-white/10', 'border-white/20');
        }
    });
    
    // Update price display
    updatePriceDisplay();
    
    // Enable confirm button
    document.getElementById('confirmSpotsButton').disabled = false;
}

// Update price display
function updatePriceDisplay() {
    const totalPrice = selectedSpots * pricePerSpot;
    document.getElementById('totalPriceDisplay').textContent = `‚Çπ${totalPrice}`;
    document.getElementById('spotsSelectedDisplay').textContent = `${selectedSpots} spot(s)`;
    document.getElementById('pricePerSpotDisplay').textContent = `‚Çπ${pricePerSpot}`;
}

// Close spot selection modal
function closeSpotModal(event) {
    if (event && event.target !== event.currentTarget) return;
    
    document.getElementById('spotSelectionModal').classList.add('hidden');
    document.getElementById('spotSelectionModal').classList.remove('flex');
    selectedSlotId = null;
    selectedSpots = 0;
    pricePerSpot = 0;
    maxSpots = 0;
}

// Confirm spot selection and proceed with booking
function confirmSpotSelection() {
    // Comprehensive validation
    if (!selectedSlotId) {
        console.error('confirmSpotSelection: selectedSlotId is null');
        alert('Slot information missing. Please close and try again.');
        return;
    }
    
    if (selectedSpots === 0 || selectedSpots < 1) {
        alert('Please select at least 1 spot');
        return;
    }
    
    if (selectedSpots > maxSpots) {
        alert(`Cannot book more than ${maxSpots} spots`);
        return;
    }
    
    console.log('‚úÖ Spot selection confirmed:', {
        slotId: selectedSlotId,
        spots: selectedSpots,
        maxSpots: maxSpots
    });
    
    // Close modal
    closeSpotModal();
    
    // Proceed with booking
    bookSlot(selectedSlotId, 'SHARED', selectedSpots);
}

// Book a slot
function bookSlot(slotId, bookingType, spotsRequested) {
    console.log('üéØ BOOKSLOT CLICKED!', { slotId, bookingType, spotsRequested });
    alert('Button clicked! SlotID: ' + slotId);
    
    // Comprehensive validation before making request
    if (!slotId) {
        console.error('bookSlot called without slotId');
        alert('Slot information missing. Please try again.');
        if (typeof hideLoading === 'function') hideLoading();
        return;
    }
    
    if (!bookingType || !['PRIVATE', 'SHARED'].includes(bookingType)) {
        console.error('bookSlot called with invalid bookingType:', bookingType);
        alert('Invalid booking type. Please try again.');
        if (typeof hideLoading === 'function') hideLoading();
        return;
    }
    
    if (!spotsRequested || spotsRequested < 1) {
        console.error('bookSlot called with invalid spotsRequested:', spotsRequested);
        alert('Invalid number of spots. Please try again.');
        if (typeof hideLoading === 'function') hideLoading();
        return;
    }
    
    const bookingData = {
        game_slot_id: slotId,
        booking_type: bookingType,
        spots_requested: spotsRequested
    };
    
    console.log('‚úÖ Sending booking request:', bookingData);
    
    // Show loading overlay
    if (typeof showLoading === 'function') {
        showLoading('Creating your booking...');
    }
    
    // Create booking using AJAX
    fetch('/booking/games/book/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify(bookingData)
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => {
                throw new Error(err.error || err.details || 'Booking failed');
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // Redirect to confirmation page
            window.location.href = data.redirect_url;
        } else {
            if (typeof hideLoading === 'function') {
                hideLoading();
            }
            
            // Build error message
            let errorMessage = data.error || 'Booking failed';
            if (data.details) {
                errorMessage += '\n\n' + data.details;
            }
            if (data.parsed) {
                console.error('Server received:', data.parsed);
            }
            
            // If authentication required, redirect to login
            if (data.redirect_url && data.error === 'Authentication required') {
                window.location.href = data.redirect_url;
            } else {
                alert(errorMessage);
                console.error('Booking error:', data);
            }
        }
    })
    .catch(error => {
        if (typeof hideLoading === 'function') {
            hideLoading();
        }
        console.error('Network/fetch error:', error);
        alert(error.message || 'An error occurred. Please try again.');
    });
}
{% endif %}

// Load initial slots on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Loading slots for date:', currentDate);
    loadSlotsForDate(currentDate);
});

</script>
{% endblock %}
