{% extends 'base.html' %}
{% load static %}

{% block title %}{{ game.name }} - Game Details{% endblock %}

{% block extra_css %}
<style>
    .slot-card {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: 2px solid transparent;
    }
    .slot-card:hover {
        transform: translateY(-4px);
        border-color: rgba(233, 69, 96, 0.5);
        box-shadow: 0 20px 40px rgba(0,0,0,0.3);
    }
    .capacity-indicator {
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }
    .capacity-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        transition: all 0.3s ease;
    }
    .capacity-dot.booked {
        background-color: #ef4444;
        box-shadow: 0 0 8px rgba(239, 68, 68, 0.6);
    }
    .capacity-dot.available {
        background-color: #10b981;
        box-shadow: 0 0 8px rgba(16, 185, 129, 0.6);
    }
    .date-tab {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .date-tab.active {
        background: linear-gradient(135deg, #e94560 0%, #00d4aa 100%);
        transform: scale(1.05);
    }
    .date-tab:hover:not(.active) {
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.4);
    }
    .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }
    .scrollbar-hide::-webkit-scrollbar {
        display: none;
    }
    
    /* Skeleton loading animation */
    .skeleton {
        animation: skeleton-loading 1s linear infinite alternate;
        background: linear-gradient(90deg, #2d2d2d 25%, #3d3d3d 50%, #2d2d2d 75%);
        background-size: 200% 100%;
    }
    @keyframes skeleton-loading {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }
    
    .fade-in {
        animation: fadeIn 0.4s ease-out;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    /* Loading spinner */
    .loading-spinner {
        display: inline-block;
        width: 50px;
        height: 50px;
        border: 5px solid rgba(255, 255, 255, 0.1);
        border-top-color: #e94560;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    .loading-overlay {
        position: relative;
        min-height: 400px;
    }
    
    .loading-message {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        z-index: 10;
    }
    
    /* Pulse animation for loading text */
    .pulse {
        animation: pulse 1.5s ease-in-out infinite;
    }
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    
    /* Spot selector button styles */
    .spot-selector-btn {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .spot-selector-btn:hover {
        transform: scale(1.05);
    }
    
    .spot-selector-btn.scale-110 {
        transform: scale(1.1);
    }
    
    /* Modal animation */
    #spotSelectionModal {
        animation: modalFadeIn 0.3s ease-out;
        backdrop-filter: blur(10px);
    }
    
    @keyframes modalFadeIn {
        from {
            opacity: 0;
            transform: scale(0.95);
        }
        to {
            opacity: 1;
            transform: scale(1);
        }
    }
    
    /* Disabled button style */
    .btn-disabled {
        background: rgba(107, 114, 128, 0.3) !important;
        color: rgba(156, 163, 175, 0.8) !important;
        cursor: not-allowed !important;
        opacity: 0.6;
    }
    
    .btn-disabled:hover {
        transform: none !important;
        box-shadow: none !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen py-8" style="background: linear-gradient(to bottom right, #111827, #1a202e, #1f2937);">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        
        <!-- Back Button -->
        <div class="mb-6">
            <a href="{% url 'home' %}" class="inline-flex items-center text-white hover:text-gaming-highlight transition-colors">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                </svg>
                Back to Home
            </a>
        </div>

        <!-- Game Header -->
        <div class="card border-2 border-white/10 mb-8 overflow-hidden">
            <div class="grid grid-cols-1 lg:grid-cols-5 gap-0">
                <!-- Game Image -->
                <div class="lg:col-span-2 h-96 lg:h-auto relative overflow-hidden">
                    {% if game.image %}
                    <img src="{{ game.image.url }}" alt="{{ game.name }}" class="w-full h-full object-cover">
                    {% else %}
                        <!-- Enhanced Placeholder based on game type -->
                        {% if 'pool' in game.name|lower or '8' in game.name or 'ball' in game.name|lower %}
                        <div class="w-full h-full bg-gradient-to-br from-emerald-900 via-teal-800 to-cyan-900 flex items-center justify-center relative overflow-hidden">
                            <!-- Pool table felt texture effect -->
                            <div class="absolute inset-0 opacity-20" style="background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.3) 2px, rgba(0,0,0,0.3) 4px);"></div>
                            <!-- Pool balls decoration -->
                            <div class="relative z-10 flex flex-col items-center">
                                <div class="flex gap-6 mb-6">
                                    <div class="w-24 h-24 rounded-full bg-white shadow-2xl flex items-center justify-center">
                                        <span class="text-4xl font-black text-gray-800">8</span>
                                    </div>
                                    <div class="w-24 h-24 rounded-full bg-gradient-to-br from-red-500 to-red-700 shadow-2xl"></div>
                                </div>
                                <div class="flex gap-6">
                                    <div class="w-24 h-24 rounded-full bg-gradient-to-br from-yellow-400 to-yellow-600 shadow-2xl"></div>
                                    <div class="w-24 h-24 rounded-full bg-gradient-to-br from-blue-500 to-blue-700 shadow-2xl"></div>
                                </div>
                            </div>
                            <!-- Cue stick decoration -->
                            <div class="absolute bottom-16 right-16 w-64 h-3 bg-gradient-to-r from-amber-800 to-amber-600 transform rotate-45 opacity-50 rounded-full shadow-xl"></div>
                        </div>
                        {% elif 'tennis' in game.name|lower or 'table tennis' in game.name|lower or 'ping' in game.name|lower %}
                        <div class="w-full h-full bg-gradient-to-br from-blue-900 via-indigo-800 to-purple-900 flex items-center justify-center relative overflow-hidden">
                            <!-- Table tennis table effect -->
                            <div class="absolute inset-0 flex items-center justify-center">
                                <div class="w-4/5 h-3/5 bg-blue-600 opacity-20 rounded-lg border-4 border-white/30"></div>
                                <div class="absolute w-4/5 h-2 bg-white/40 top-1/2 transform -translate-y-1/2"></div>
                            </div>
                            <!-- Ping pong elements -->
                            <div class="relative z-10 flex flex-col items-center gap-8">
                                <!-- Paddles -->
                                <div class="flex gap-12 items-center">
                                    <div class="relative">
                                        <div class="w-28 h-32 rounded-full bg-gradient-to-br from-red-600 to-red-800 shadow-2xl"></div>
                                        <div class="w-8 h-20 bg-amber-700 absolute bottom-0 left-1/2 transform -translate-x-1/2 translate-y-16 rounded shadow-xl"></div>
                                    </div>
                                    <div class="w-16 h-16 rounded-full bg-white shadow-2xl animate-pulse"></div>
                                    <div class="relative">
                                        <div class="w-28 h-32 rounded-full bg-gradient-to-br from-gray-800 to-gray-900 shadow-2xl"></div>
                                        <div class="w-8 h-20 bg-amber-700 absolute bottom-0 left-1/2 transform -translate-x-1/2 translate-y-16 rounded shadow-xl"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <div class="w-full h-full bg-gradient-to-br from-primary-600 via-purple-600 to-secondary-600 flex items-center justify-center relative overflow-hidden">
                            <div class="absolute inset-0 opacity-10" style="background: radial-gradient(circle at 30% 50%, rgba(255,255,255,0.2) 0%, transparent 50%);"></div>
                            <div class="relative z-10">
                                <i class="bi bi-trophy-fill text-white text-9xl opacity-80 drop-shadow-2xl"></i>
                            </div>
                        </div>
                        {% endif %}
                    {% endif %}
                    
                    <!-- Booking Type Badge -->
                    <div class="absolute top-4 right-4">
                        {% if game.booking_type == 'HYBRID' %}
                        <span class="badge badge-success text-sm shadow-lg">
                            ü§ù Private + Shared Available
                        </span>
                        {% else %}
                        <span class="badge badge-primary text-sm shadow-lg">
                            üîí Private Booking Only
                        </span>
                        {% endif %}
                    </div>
                </div>

                <!-- Game Info -->
                <div class="lg:col-span-3 p-8 lg:p-10">
                    <h1 class="text-5xl font-black text-white mb-4">{{ game.name }}</h1>
                    <p class="text-gray-300 text-lg mb-8 leading-relaxed">{{ game.description|default:"Professional gaming experience with premium equipment and perfect ambiance." }}</p>
                    
                    <!-- Game Details Grid -->
                    <div class="grid grid-cols-2 gap-4 mb-8">
                        <div class="bg-white/5 rounded-xl p-5 border border-white/10 hover:bg-white/10 transition-all">
                            <div class="text-gray-400 text-sm mb-2 flex items-center gap-2">
                                <i class="bi bi-people-fill text-primary-400"></i>
                                Capacity
                            </div>
                            <div class="text-white text-2xl font-bold">{{ game.capacity }} Player{{ game.capacity|pluralize }}</div>
                        </div>
                        
                        <div class="bg-white/5 rounded-xl p-5 border border-white/10 hover:bg-white/10 transition-all">
                            <div class="text-gray-400 text-sm mb-2 flex items-center gap-2">
                                <i class="bi bi-clock-fill text-secondary-400"></i>
                                Slot Duration
                            </div>
                            <div class="text-white text-2xl font-bold">{{ game.slot_duration_minutes }} Minutes</div>
                        </div>
                        
                        <div class="bg-gradient-to-br from-red-500/20 to-pink-500/20 rounded-xl p-5 border border-red-400/30 hover:border-red-400/50 transition-all">
                            <div class="text-red-200 text-sm mb-2 flex items-center gap-2">
                                <i class="bi bi-wallet2"></i>
                                Private Price
                            </div>
                            <div class="text-white text-2xl font-bold">‚Çπ{{ game.private_price }}</div>
                        </div>
                        
                        {% if game.booking_type == 'HYBRID' %}
                        <div class="bg-gradient-to-br from-green-500/20 to-emerald-500/20 rounded-xl p-5 border border-green-400/30 hover:border-green-400/50 transition-all">
                            <div class="text-green-200 text-sm mb-2 flex items-center gap-2">
                                <i class="bi bi-wallet2"></i>
                                Shared Price (per person)
                            </div>
                            <div class="text-white text-2xl font-bold">‚Çπ{{ game.shared_price }}</div>
                        </div>
                        {% endif %}
                    </div>

                    {% if not is_authenticated %}
                    <!-- Login CTA for non-authenticated users -->
                    <div class="bg-gradient-to-r from-primary-600 to-secondary-600 rounded-xl p-6 text-center">
                        <p class="text-white font-bold text-lg mb-4">Login to book this game!</p>
                        <a href="{% url 'authentication:customer_login' %}?next={{ request.path }}" 
                           class="btn btn-light btn-lg hover-glow">
                            <i class="bi bi-box-arrow-in-right"></i>
                            Login Now
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Date Selection -->
        <div class="mb-10">
            <h2 class="text-3xl font-black text-white mb-6 flex items-center gap-3">
                <i class="bi bi-calendar-event text-primary-400"></i>
                Select Date
            </h2>
            <div class="flex space-x-4 overflow-x-auto pb-4 scrollbar-hide py-2">
                {% for date in date_range %}
                <button type="button"
                        onclick="selectDate('{{ date.isoformat }}')" 
                        class="date-tab flex-shrink-0 px-8 py-4 rounded-xl text-center min-w-[140px] transition-all duration-300 {% if date == selected_date %}active text-white shadow-2xl{% else %}bg-white/5 text-gray-300 hover:bg-white/10{% endif %} border-2 border-white/10"
                        data-date="{{ date.isoformat }}">
                    <div class="font-bold text-lg mb-1">
                        {% if date == today %}Today{% else %}{{ date|date:"M d" }}{% endif %}
                    </div>
                    <div class="text-sm opacity-80">{{ date|date:"D" }}</div>
                </button>
                {% endfor %}
            </div>
        </div>

        <!-- Available Slots for Selected Date -->
        <div>
            <h2 class="text-3xl font-black text-white mb-6 flex items-center gap-3">
                <i class="bi bi-clock-history text-secondary-400"></i>
                <span>Available Time Slots</span>
                <span id="liveIndicator" class="ml-auto flex items-center gap-2 text-xs font-medium text-success opacity-0 transition-opacity duration-300">
                    <span class="w-2 h-2 rounded-full bg-success animate-pulse"></span>
                    Live Updates Active
                </span>
            </h2>
            <div class="mb-4 card p-4 flex items-center justify-between">
                <span class="text-gray-300 font-medium" id="selectedDateDisplay">{{ selected_date|date:"l, F d, Y" }}</span>
                {% if selected_date == today %}
                <span class="badge badge-primary">Today</span>
                {% endif %}
            </div>
            
            <!-- Slots Container - Loaded via AJAX -->
            <div id="slotsContainer">
                <!-- Initial Loading State -->
                <div class="loading-overlay">
                    <div class="loading-message fade-in">
                        <div class="loading-spinner mx-auto mb-4"></div>
                        <p class="text-white text-lg font-medium pulse">Loading available slots...</p>
                        <p class="text-gray-400 text-sm mt-2">Fetching the latest availability</p>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- Spot Selection Modal -->
<div id="spotSelectionModal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden flex items-center justify-center p-4" onclick="closeSpotModal(event)">
    <div class="bg-gradient-to-br from-gaming-secondary to-gaming-accent rounded-2xl max-w-md w-full p-8 border border-white/20" onclick="event.stopPropagation()">
        <div class="text-center mb-6">
            <div class="text-6xl mb-4">üéÆ</div>
            <h3 class="text-2xl font-bold text-white mb-2">Select Number of Spots</h3>
            <p class="text-gray-300 text-sm">How many people are joining?</p>
        </div>

        <!-- Spot Selection Grid -->
        <div id="spotSelectionGrid" class="grid grid-cols-4 gap-3 mb-6">
            <!-- Dynamically filled -->
        </div>

        <!-- Total Price Display -->
        <div class="bg-white/10 rounded-lg p-4 mb-6 border border-white/20">
            <div class="flex justify-between items-center">
                <span class="text-gray-300">Total Price:</span>
                <span id="totalPriceDisplay" class="text-gaming-highlight text-2xl font-bold">‚Çπ0</span>
            </div>
            <div class="text-xs text-gray-400 mt-1">
                <span id="spotsSelectedDisplay">0 spot(s)</span> √ó <span id="pricePerSpotDisplay">‚Çπ0</span>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex space-x-3">
            <button onclick="closeSpotModal()" 
                    class="flex-1 bg-white/10 hover:bg-white/20 text-white px-6 py-3 rounded-lg font-medium transition-colors border border-white/20">
                Cancel
            </button>
            <button id="confirmSpotsButton" onclick="confirmSpotSelection()" 
                    class="flex-1 bg-gaming-highlight hover:bg-gaming-highlight/80 text-white px-6 py-3 rounded-lg font-semibold transition-colors shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
                    disabled>
                Confirm Booking
            </button>
        </div>
    </div>
</div>

<script>
// Configuration
const isAuthenticated = '{{ is_authenticated|yesno:"true,false" }}';
const gameId = "{{ game.id }}";
const csrfToken = "{{ csrf_token }}";
let currentDate = "{{ selected_date.isoformat }}";

// Format date display
function formatDateDisplay(dateStr) {
    const date = new Date(dateStr + 'T00:00:00');
    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    return date.toLocaleDateString('en-US', options);
}

// Check if date is today
function isToday(dateStr) {
    const today = new Date();
    const date = new Date(dateStr + 'T00:00:00');
    return date.toDateString() === today.toDateString();
}

// Select date and load slots
function selectDate(dateStr) {
    currentDate = dateStr;
    
    // Update active state on date buttons with smooth transition
    document.querySelectorAll('.date-tab').forEach(btn => {
        if (btn.dataset.date === dateStr) {
            btn.classList.add('active', 'text-white', 'shadow-2xl');
            btn.classList.remove('bg-white/5', 'text-gray-300');
        } else {
            btn.classList.remove('active', 'text-white', 'shadow-2xl');
            btn.classList.add('bg-white/5', 'text-gray-300');
        }
    });
    
    // Update date display
    const displayText = formatDateDisplay(dateStr);
    const displayElement = document.getElementById('selectedDateDisplay');
    if (displayElement) {
        displayElement.textContent = displayText;
    }
    
    // Scroll slots container into view smoothly
    document.getElementById('slotsContainer').scrollIntoView({ 
        behavior: 'smooth', 
        block: 'nearest' 
    });
    
    // Stop current polling
    stopPolling();
    
    // Load slots for selected date
    loadSlotsForDate(dateStr);
    
    // Restart polling immediately
    setTimeout(() => {
        startPolling();
    }, 1000);
}

// Load slots via API (OPTIMIZED WITH AJAX)
function loadSlotsForDate(dateStr) {
    const container = document.getElementById('slotsContainer');
    
    // Show beautiful loading spinner with message
    container.innerHTML = `
        <div class="loading-overlay">
            <div class="loading-message fade-in">
                <div class="loading-spinner mx-auto mb-4"></div>
                <p class="text-white text-lg font-medium pulse">Loading slots...</p>
                <p class="text-gray-400 text-sm mt-2">Please wait a moment</p>
            </div>
        </div>
    `;
    
    // Fetch slots from API
    fetch(`/api/games/${gameId}/slots/?date=${dateStr}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to load slots');
            }
            return response.json();
        })
        .then(data => {
            currentSlotsData = data.slots; // Store for comparison
            renderSlots(data.slots);
        })
        .catch(error => {
            showError('Unable to load slots. Please try again.');
        });
}

// Render slots from API data
function renderSlots(slots) {
    const container = document.getElementById('slotsContainer');
    
    if (!slots || slots.length === 0) {
        container.innerHTML = `
            <div class="text-center py-20 card fade-in">
                <div class="text-gray-400 text-7xl mb-6">üìÖ</div>
                <p class="text-white text-2xl font-bold mb-3">No slots available for this date</p>
                <p class="text-gray-400 text-lg">Try selecting a different date or check back later</p>
            </div>
        `;
        return;
    }
    
    let html = '<div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">';
    
    slots.forEach(slot => {
        const availability = slot.availability;
        const bookingOptions = slot.booking_options;
        
        html += `
            <div class="slot-card card hover-lift fade-in">
                <!-- Time Header -->
                <div class="flex items-center justify-between mb-4 pb-4 border-b border-white/10">
                    <div class="flex items-center gap-3">
                        <i class="bi bi-clock text-primary-400 text-2xl"></i>
                        <span class="text-white font-black text-2xl">
                            ${slot.time_display}
                        </span>
                    </div>
                    <div class="capacity-indicator">
                        ${renderCapacityDots(availability)}
                        <span class="text-sm text-gray-400 ml-2 font-medium">
                            ${availability.available_spots}/${availability.total_capacity}
                        </span>
                    </div>
                </div>

                <!-- Booking Options -->
                <div class="space-y-3">
                    ${renderBookingOptions(slot, bookingOptions)}
                </div>

                ${availability.available_spots === 0 ? `
                <div class="mt-4 text-center">
                    <span class="inline-flex items-center gap-2 bg-error/20 text-error px-4 py-2 rounded-lg text-sm font-bold border border-error/30">
                        <i class="bi bi-x-circle-fill"></i>
                        Fully Booked
                    </span>
                </div>
                ` : ''}
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

// Render capacity indicator dots
function renderCapacityDots(availability) {
    let html = '';
    for (let i = 0; i < availability.total_capacity; i++) {
        const dotClass = i < availability.booked_spots ? 'booked' : 'available';
        html += `<div class="capacity-dot ${dotClass}"></div>`;
    }
    return html;
}

// Render booking options (private/shared)
function renderBookingOptions(slot, options) {
    if (!options || options.length === 0) {
        return '<p class="text-gray-400 text-sm">No booking options available</p>';
    }
    
    let html = '';
    
    options.forEach(option => {
        if (option.type === 'PRIVATE') {
            html += renderPrivateOption(slot, option);
        } else if (option.type === 'SHARED') {
            html += renderSharedOption(slot, option);
        }
    });
    
    return html;
}

// Render private booking option
function renderPrivateOption(slot, option) {
    const disabled = !option.available;
    
    return `
        <div class="bg-gradient-to-br from-blue-500/20 to-blue-600/20 border-2 border-blue-400/30 rounded-xl p-4 hover:border-blue-400/50 transition-all">
            <div class="flex items-center justify-between mb-3">
                <span class="text-blue-200 font-bold flex items-center gap-2">
                    <i class="bi bi-lock-fill"></i>
                    Private Booking
                </span>
                <span class="text-blue-300 font-black text-xl">‚Çπ${option.price}</span>
            </div>
            <div class="text-blue-200 text-sm mb-3 opacity-90">${option.description}</div>
            ${isAuthenticated === 'true' ? `
                <button onclick="bookSlot('${slot.id}', 'PRIVATE', ${option.capacity}, event)" 
                        ${disabled ? 'disabled' : ''}
                        class="w-full ${disabled ? 'btn-disabled' : 'btn btn-primary hover-glow'} transition-all">
                    ${disabled ? '<i class="bi bi-x-circle"></i> Not Available' : '<i class="bi bi-calendar-check"></i> Book Private'}
                </button>
            ` : `
                <a href="/accounts/login/?next=${window.location.pathname}" 
                   class="btn btn-primary w-full text-center hover-glow">
                    <i class="bi bi-box-arrow-in-right"></i> Login to Book
                </a>
            `}
        </div>
    `;
}

// Render shared booking option
function renderSharedOption(slot, option) {
    const disabled = !option.available;
    const pricePerSpot = option.price_per_spot || option.price || 0;
    const availableSpots = option.available_spots || 0;
    const maxSpotsPerBooking = option.max_spots_per_booking || 4;
    
    return `
        <div class="bg-gradient-to-br from-green-500/20 to-emerald-600/20 border-2 border-green-400/30 rounded-xl p-4 hover:border-green-400/50 transition-all">
            <div class="flex items-center justify-between mb-3">
                <span class="text-green-200 font-bold flex items-center gap-2">
                    <i class="bi bi-people-fill"></i>
                    Shared Booking
                </span>
                <span class="text-green-300 font-black text-xl">‚Çπ${pricePerSpot}/person</span>
            </div>
            <div class="text-green-200 text-sm mb-3 opacity-90">${option.description}</div>
            ${isAuthenticated === 'true' ? `
                <button onclick="showSpotSelectionModal('${slot.id}', ${availableSpots}, ${pricePerSpot}, ${maxSpotsPerBooking})" 
                        ${disabled ? 'disabled' : ''}
                        class="w-full ${disabled ? 'btn-disabled' : 'btn btn-success hover-glow'} transition-all">
                    ${disabled ? '<i class="bi bi-x-circle"></i> Not Available' : '<i class="bi bi-calendar-check"></i> Book Shared'}
                </button>
            ` : `
                <a href="/accounts/login/?next=${window.location.pathname}" 
                   class="btn btn-success w-full text-center hover-glow">
                    <i class="bi bi-box-arrow-in-right"></i> Login to Book
                </a>
            `}
        </div>
    `;
}

// Show error message
function showError(message) {
    const container = document.getElementById('slotsContainer');
    container.innerHTML = `
        <div class="text-center py-16 bg-red-500/10 rounded-2xl border border-red-500/30 fade-in">
            <div class="text-red-400 text-6xl mb-4">‚ö†Ô∏è</div>
            <p class="text-red-300 text-lg mb-2">${message}</p>
            <button onclick="loadSlotsForDate(currentDate)" 
                    class="mt-4 bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-lg transition-colors">
                Try Again
            </button>
        </div>
    `;
}

{% if is_authenticated %}
// Spot selection modal variables
let selectedSlotId = null;
let selectedSpots = 0;
let pricePerSpot = 0;
let maxSpots = 0;

// Show spot selection modal
function showSpotSelectionModal(slotId, availableSpots, spotPrice, maxSpotsPerBooking) {
    selectedSlotId = slotId;
    pricePerSpot = spotPrice;
    maxSpots = Math.min(availableSpots, maxSpotsPerBooking);
    selectedSpots = 0;
    
    // Build spot selection grid
    const grid = document.getElementById('spotSelectionGrid');
    grid.innerHTML = '';
    
    for (let i = 1; i <= maxSpots; i++) {
        const button = document.createElement('button');
        button.className = 'spot-selector-btn bg-white/10 hover:bg-white/20 text-white rounded-lg py-4 font-bold text-lg transition-all border-2 border-white/20 hover:border-gaming-highlight';
        button.textContent = i;
        button.onclick = () => selectNumberOfSpots(i);
        grid.appendChild(button);
    }
    
    // Update displays
    updatePriceDisplay();
    
    // Show modal
    document.getElementById('spotSelectionModal').classList.remove('hidden');
    document.getElementById('spotSelectionModal').classList.add('flex');
}

// Select number of spots
function selectNumberOfSpots(spots) {
    selectedSpots = spots;
    
    // Update button states
    const buttons = document.querySelectorAll('.spot-selector-btn');
    buttons.forEach((btn, index) => {
        if (index + 1 === spots) {
            btn.classList.add('bg-gaming-highlight', 'border-gaming-highlight', 'scale-110', 'shadow-lg');
            btn.classList.remove('bg-white/10', 'border-white/20');
        } else {
            btn.classList.remove('bg-gaming-highlight', 'border-gaming-highlight', 'scale-110', 'shadow-lg');
            btn.classList.add('bg-white/10', 'border-white/20');
        }
    });
    
    // Update price display
    updatePriceDisplay();
    
    // Enable confirm button
    document.getElementById('confirmSpotsButton').disabled = false;
}

// Update price display
function updatePriceDisplay() {
    const totalPrice = selectedSpots * pricePerSpot;
    document.getElementById('totalPriceDisplay').textContent = `‚Çπ${totalPrice}`;
    document.getElementById('spotsSelectedDisplay').textContent = `${selectedSpots} spot(s)`;
    document.getElementById('pricePerSpotDisplay').textContent = `‚Çπ${pricePerSpot}`;
}

// Close spot selection modal
function closeSpotModal(event) {
    if (event && event.target !== event.currentTarget) return;
    
    const modal = document.getElementById('spotSelectionModal');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
    selectedSlotId = null;
    selectedSpots = 0;
    pricePerSpot = 0;
    maxSpots = 0;
}

// Confirm spot selection and proceed with booking
function confirmSpotSelection() {
    // Comprehensive validation
    if (!selectedSlotId) {
        alert('Slot information missing. Please close and try again.');
        return;
    }
    
    if (selectedSpots === 0 || selectedSpots < 1) {
        alert('Please select at least 1 spot');
        return;
    }
    
    if (selectedSpots > maxSpots) {
        alert(`Cannot book more than ${maxSpots} spots`);
        return;
    }
    
    // Store values before closing modal (to prevent reset)
    const slotIdToBook = selectedSlotId;
    const spotsToBook = selectedSpots;
    
    // Close modal (this will reset the global variables)
    closeSpotModal();
    
    // Proceed with booking using stored values
    bookSlot(slotIdToBook, 'SHARED', spotsToBook, null);
}

// Book a slot
function bookSlot(slotId, bookingType, spotsRequested, event) {
    // Comprehensive validation before making request
    if (!slotId) {
        alert('Slot information missing. Please try again.');
        return;
    }
    
    if (!bookingType || !['PRIVATE', 'SHARED'].includes(bookingType)) {
        alert('Invalid booking type. Please try again.');
        return;
    }
    
    if (!spotsRequested || spotsRequested < 1) {
        alert('Invalid number of spots. Please try again.');
        return;
    }
    
    const bookingData = {
        game_slot_id: slotId,
        booking_type: bookingType,
        spots_requested: spotsRequested
    };
    
    // Show loading state on button if event is provided
    let clickedButton = null;
    if (event && event.target) {
        clickedButton = event.target;
        clickedButton.disabled = true;
        const originalText = clickedButton.innerHTML;
        clickedButton.innerHTML = '<i class="bi bi-arrow-repeat animate-spin"></i> Processing...';
        clickedButton.dataset.originalText = originalText;
    }
    
    // Create booking using AJAX
    fetch('/booking/games/book/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify(bookingData)
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => {
                throw new Error(err.error || err.details || 'Booking failed');
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // Redirect to confirmation page
            window.location.href = data.redirect_url;
        } else {
            // Restore button state
            if (clickedButton && clickedButton.dataset.originalText) {
                clickedButton.disabled = false;
                clickedButton.innerHTML = clickedButton.dataset.originalText;
            }
            
            // Build error message
            let errorMessage = data.error || 'Booking failed';
            if (data.details) {
                errorMessage += '\n\n' + data.details;
            }
            
            // If authentication required, redirect to login
            if (data.redirect_url && data.error === 'Authentication required') {
                window.location.href = data.redirect_url;
            } else {
                alert(errorMessage);
            }
        }
    })
    .catch(error => {
        // Restore button state
        if (clickedButton && clickedButton.dataset.originalText) {
            clickedButton.disabled = false;
            clickedButton.innerHTML = clickedButton.dataset.originalText;
        }
        alert(error.message || 'An error occurred. Please try again.');
    });
}
{% endif %}

// Real-time polling for slot updates
let pollingInterval = null;
const POLLING_INTERVAL_MS = 3000; // Poll every 3 seconds for real-time updates

function startPolling() {
    // Clear any existing interval
    if (pollingInterval) {
        clearInterval(pollingInterval);
    }
    
    // Show live indicator
    const liveIndicator = document.getElementById('liveIndicator');
    if (liveIndicator) {
        liveIndicator.style.opacity = '1';
    }
    
    // Start polling
    pollingInterval = setInterval(() => {
        // Silently refresh slots without showing loading spinner
        fetch(`/api/games/${gameId}/slots/?date=${currentDate}`)
            .then(response => {
                if (response.ok) {
                    return response.json();
                }
            })
            .then(data => {
                if (data && data.slots) {
                    // Only update if the data has changed
                    updateSlotsIfChanged(data.slots);
                }
            })
            .catch(error => {
                // Silently handle errors to avoid interrupting user experience
                console.error('Polling error:', error);
            });
    }, POLLING_INTERVAL_MS);
}

function stopPolling() {
    if (pollingInterval) {
        clearInterval(pollingInterval);
        pollingInterval = null;
    }
    
    // Hide live indicator
    const liveIndicator = document.getElementById('liveIndicator');
    if (liveIndicator) {
        liveIndicator.style.opacity = '0';
    }
}

// Store current slots data for comparison
let currentSlotsData = null;

function updateSlotsIfChanged(newSlots) {
    // Convert to JSON string for simple comparison
    const newSlotsStr = JSON.stringify(newSlots);
    const currentSlotsStr = JSON.stringify(currentSlotsData);
    
    if (newSlotsStr !== currentSlotsStr) {
        currentSlotsData = newSlots;
        renderSlots(newSlots);
        
        // Show subtle notification
        showUpdateNotification();
    }
}

function showUpdateNotification() {
    const notification = document.createElement('div');
    notification.className = 'fixed top-4 right-4 z-50 glass rounded-xl px-4 py-3 max-w-sm transform translate-x-full transition-transform duration-300 border-success/30 text-success';
    notification.innerHTML = `
        <div class="flex items-center gap-3">
            <svg class="w-5 h-5 flex-shrink-0 animate-pulse" fill="currentColor" viewBox="0 0 16 16">
                <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/>
            </svg>
            <span class="text-sm font-medium">Availability updated</span>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Animate in
    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
    }, 100);
    
    // Auto remove after 3 seconds
    setTimeout(() => {
        notification.style.transform = 'translateX(full)';
        setTimeout(() => {
            notification.remove();
        }, 300);
    }, 3000);
}

// Pause polling when page is not visible
document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
        stopPolling();
    } else {
        // Immediately refresh when page becomes visible
        loadSlotsForDate(currentDate);
        startPolling();
    }
});

// Load initial slots on page load
document.addEventListener('DOMContentLoaded', function() {
    loadSlotsForDate(currentDate);
    
    // Start real-time polling immediately after initial load
    setTimeout(() => {
        startPolling();
    }, 1000); // Wait 1 second before starting polling
});

// Clean up on page unload
window.addEventListener('beforeunload', function() {
    stopPolling();
});

</script>
{% endblock %}
