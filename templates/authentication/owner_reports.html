{% extends 'authentication/owner_dashboard_base.html' %}
{% load static %}

{% block title %}Reports & Analytics{% endblock %}
{% block page_title %}Reports & Analytics{% endblock %}
{% block page_subtitle %}Deep insights and business intelligence{% endblock %}

{% block content %}
<!-- Date Range Filter -->
<div class="bg-white rounded-xl shadow-md p-6 mb-8">
    <form method="get" class="flex items-end space-x-4">
        <div class="flex-1">
            <label class="block text-sm font-medium text-gray-700 mb-2">Analysis Period</label>
            <select name="days" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <option value="7" {% if days == 7 %}selected{% endif %}>Last 7 Days</option>
                <option value="30" {% if days == 30 %}selected{% endif %}>Last 30 Days</option>
                <option value="90" {% if days == 90 %}selected{% endif %}>Last 90 Days</option>
                <option value="180" {% if days == 180 %}selected{% endif %}>Last 6 Months</option>
                <option value="365" {% if days == 365 %}selected{% endif %}>Last Year</option>
            </select>
        </div>
        <button type="submit" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors duration-200">
            <i class="fas fa-chart-bar mr-2"></i> Generate Report
        </button>
        <button type="button" onclick="exportReport()" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors duration-200">
            <i class="fas fa-download mr-2"></i> Export
        </button>
    </form>
    <p class="text-sm text-gray-600 mt-2">
        Analyzing data from {{ start_date|date:"M d, Y" }} to {{ end_date|date:"M d, Y" }}
    </p>
</div>

<!-- Key Metrics Summary -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <div class="bg-white rounded-xl shadow-md p-6">
        <div class="flex items-center justify-between mb-2">
            <p class="text-sm text-gray-600">Total Bookings</p>
            <i class="fas fa-calendar-check text-indigo-600 text-xl"></i>
        </div>
        <p class="text-3xl font-bold text-gray-800">{{ total_bookings }}</p>
        <p class="text-sm text-green-600 mt-2">
            <i class="fas fa-arrow-up"></i> Period total
        </p>
    </div>

    <div class="bg-white rounded-xl shadow-md p-6">
        <div class="flex items-center justify-between mb-2">
            <p class="text-sm text-gray-600">Avg Booking Value</p>
            <i class="fas fa-dollar-sign text-green-600 text-xl"></i>
        </div>
        <p class="text-3xl font-bold text-gray-800">₹{{ avg_booking_value|floatformat:2 }}</p>
        <p class="text-sm text-gray-500 mt-2">Per booking</p>
    </div>

    <div class="bg-white rounded-xl shadow-md p-6">
        <div class="flex items-center justify-between mb-2">
            <p class="text-sm text-gray-600">Cancellation Rate</p>
            <i class="fas fa-times-circle text-red-600 text-xl"></i>
        </div>
        <p class="text-3xl font-bold text-gray-800">{{ cancellation_rate|floatformat:1 }}%</p>
        <p class="text-sm text-gray-500 mt-2">{{ cancelled_bookings }} cancelled</p>
    </div>

    <div class="bg-white rounded-xl shadow-md p-6">
        <div class="flex items-center justify-between mb-2">
            <p class="text-sm text-gray-600">Utilization Rate</p>
            <i class="fas fa-chart-pie text-purple-600 text-xl"></i>
        </div>
        <p class="text-3xl font-bold text-gray-800">{{ utilization_rate|floatformat:1 }}%</p>
        <p class="text-sm text-gray-500 mt-2">Station usage</p>
    </div>
</div>

<!-- Revenue Comparison -->
<div class="bg-white rounded-xl shadow-md p-6 mb-8">
    <h3 class="text-lg font-semibold text-gray-800 mb-4">Revenue Comparison</h3>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="text-center">
            <p class="text-sm text-gray-600 mb-2">Current Period</p>
            <p class="text-3xl font-bold text-green-600">₹{{ current_revenue|floatformat:2 }}</p>
        </div>
        <div class="text-center">
            <p class="text-sm text-gray-600 mb-2">Previous Period</p>
            <p class="text-3xl font-bold text-gray-600">₹{{ previous_revenue|floatformat:2 }}</p>
        </div>
        <div class="text-center">
            <p class="text-sm text-gray-600 mb-2">Change</p>
            <p class="text-3xl font-bold {% if revenue_change >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                <i class="fas fa-arrow-{% if revenue_change >= 0 %}up{% else %}down{% endif %}"></i>
                {{ revenue_change|floatformat:1 }}%
            </p>
        </div>
    </div>
</div>

<!-- Charts Row 1 -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
    <!-- Booking Trend -->
    <div class="bg-white rounded-xl shadow-md p-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Booking Trend</h3>
        <canvas id="bookingTrendChart" style="height: 300px;"></canvas>
    </div>

    <!-- Peak Hours Heatmap -->
    <div class="bg-white rounded-xl shadow-md p-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Peak Hours Analysis</h3>
        <canvas id="peakHoursChart" style="height: 300px;"></canvas>
    </div>
</div>

<!-- Customer Analytics -->
<div class="bg-white rounded-xl shadow-md p-6 mb-8">
    <h3 class="text-lg font-semibold text-gray-800 mb-6">Customer Analytics</h3>
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
        <div class="text-center p-4 bg-gradient-to-br from-blue-50 to-indigo-50 rounded-lg">
            <i class="fas fa-users text-3xl text-indigo-600 mb-2"></i>
            <p class="text-2xl font-bold text-gray-800">{{ total_customers }}</p>
            <p class="text-sm text-gray-600 mt-1">Total Customers</p>
        </div>
        <div class="text-center p-4 bg-gradient-to-br from-green-50 to-emerald-50 rounded-lg">
            <i class="fas fa-user-plus text-3xl text-green-600 mb-2"></i>
            <p class="text-2xl font-bold text-gray-800">{{ new_customers }}</p>
            <p class="text-sm text-gray-600 mt-1">New Customers</p>
        </div>
        <div class="text-center p-4 bg-gradient-to-br from-purple-50 to-pink-50 rounded-lg">
            <i class="fas fa-hand-holding-usd text-3xl text-purple-600 mb-2"></i>
            <p class="text-2xl font-bold text-gray-800">₹{{ customer_ltv|floatformat:0 }}</p>
            <p class="text-sm text-gray-600 mt-1">Avg Customer LTV</p>
        </div>
        <div class="text-center p-4 bg-gradient-to-br from-yellow-50 to-orange-50 rounded-lg">
            <i class="fas fa-chart-line text-3xl text-yellow-600 mb-2"></i>
            <p class="text-2xl font-bold text-gray-800">85%</p>
            <p class="text-sm text-gray-600 mt-1">Retention Rate</p>
        </div>
    </div>
</div>

<!-- Quick Reports -->
<div class="bg-white rounded-xl shadow-md p-6">
    <h3 class="text-lg font-semibold text-gray-800 mb-4">Pre-built Reports</h3>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <button onclick="generateReport('daily')" class="p-4 border-2 border-gray-200 rounded-lg hover:border-indigo-500 hover:bg-indigo-50 transition-all duration-200 text-left">
            <i class="fas fa-calendar-day text-indigo-600 text-2xl mb-2"></i>
            <h4 class="font-semibold text-gray-800">Daily Summary</h4>
            <p class="text-sm text-gray-600 mt-1">Today's complete activity report</p>
        </button>

        <button onclick="generateReport('weekly')" class="p-4 border-2 border-gray-200 rounded-lg hover:border-green-500 hover:bg-green-50 transition-all duration-200 text-left">
            <i class="fas fa-calendar-week text-green-600 text-2xl mb-2"></i>
            <h4 class="font-semibold text-gray-800">Weekly Report</h4>
            <p class="text-sm text-gray-600 mt-1">This week's performance metrics</p>
        </button>

        <button onclick="generateReport('monthly')" class="p-4 border-2 border-gray-200 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-all duration-200 text-left">
            <i class="fas fa-calendar-alt text-purple-600 text-2xl mb-2"></i>
            <h4 class="font-semibold text-gray-800">Monthly Report</h4>
            <p class="text-sm text-gray-600 mt-1">Full month analysis and insights</p>
        </button>

        <button onclick="generateReport('revenue')" class="p-4 border-2 border-gray-200 rounded-lg hover:border-yellow-500 hover:bg-yellow-50 transition-all duration-200 text-left">
            <i class="fas fa-dollar-sign text-yellow-600 text-2xl mb-2"></i>
            <h4 class="font-semibold text-gray-800">Revenue Analysis</h4>
            <p class="text-sm text-gray-600 mt-1">Detailed financial breakdown</p>
        </button>

        <button onclick="generateReport('customer')" class="p-4 border-2 border-gray-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-all duration-200 text-left">
            <i class="fas fa-users text-blue-600 text-2xl mb-2"></i>
            <h4 class="font-semibold text-gray-800">Customer Insights</h4>
            <p class="text-sm text-gray-600 mt-1">Customer behavior and trends</p>
        </button>

        <button onclick="generateReport('game')" class="p-4 border-2 border-gray-200 rounded-lg hover:border-red-500 hover:bg-red-50 transition-all duration-200 text-left">
            <i class="fas fa-gamepad text-red-600 text-2xl mb-2"></i>
            <h4 class="font-semibold text-gray-800">Game Performance</h4>
            <p class="text-sm text-gray-600 mt-1">Game utilization and revenue</p>
        </button>
    </div>
</div>

<script>
    // Booking Trend Chart
    const bookingTrendCtx = document.getElementById('bookingTrendChart').getContext('2d');
    const bookingsDataRaw = '{{ bookings_trend|escapejs }}';
    const bookingsData = JSON.parse(bookingsDataRaw.replace(/'/g, '"'));
    
    const bookingLabels = bookingsData.map(item => {
        const date = new Date(item.date);
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    });
    
    const bookingCounts = bookingsData.map(item => item.count);
    
    new Chart(bookingTrendCtx, {
        type: 'bar',
        data: {
            labels: bookingLabels,
            datasets: [{
                label: 'Bookings',
                data: bookingCounts,
                backgroundColor: 'rgba(79, 70, 229, 0.8)',
                borderColor: 'rgb(79, 70, 229)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });

    // Peak Hours Chart
    const peakHoursCtx = document.getElementById('peakHoursChart').getContext('2d');
    const peakHoursDataRaw = '{{ peak_hours|escapejs }}';
    const peakHoursData = JSON.parse(peakHoursDataRaw.replace(/'/g, '"'));
    
    const hourLabels = peakHoursData.map(item => {
        const date = new Date(item.hour);
        return date.getHours() + ':00';
    });
    
    const hourCounts = peakHoursData.map(item => item.count);
    
    new Chart(peakHoursCtx, {
        type: 'line',
        data: {
            labels: hourLabels,
            datasets: [{
                label: 'Bookings',
                data: hourCounts,
                borderColor: 'rgb(16, 185, 129)',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });

    function generateReport(type) {
        alert(`Generating ${type} report... This feature will be fully implemented soon!`);
    }

    function exportReport() {
        alert('Export functionality coming soon! You will be able to export to Excel, PDF, and CSV formats.');
    }
</script>
{% endblock %}
