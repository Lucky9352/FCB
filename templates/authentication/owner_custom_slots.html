{% extends 'authentication/owner_dashboard_base.html' %}
{% load static %}

{% block title %}Add Custom Slots{% endblock %}
{% block page_title %}Add Custom Time Slots{% endblock %}
{% block page_subtitle %}Create special slots outside regular schedule{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Instructions Card -->
    <div class="bg-blue-50 border-l-4 border-blue-500 p-6 mb-8 rounded-lg">
        <div class="flex items-start">
            <i class="fas fa-info-circle text-blue-500 text-2xl mr-4 mt-1"></i>
            <div>
                <h3 class="text-lg font-semibold text-blue-900 mb-2">What are Custom Slots?</h3>
                <p class="text-blue-800 mb-2">Custom slots allow you to add special time slots outside your game's regular schedule.</p>
                <p class="text-blue-700 text-sm">
                    <strong>Examples:</strong> Extended hours for holidays, special events, one-time tournaments, or emergency availability.
                </p>
            </div>
        </div>
    </div>

    <!-- Custom Slot Form -->
    <div class="bg-white rounded-xl shadow-md p-8">
        <form method="post" id="customSlotForm">
            {% csrf_token %}
            
            <!-- Game Selection -->
            <div class="mb-8">
                <label class="block text-lg font-semibold text-gray-800 mb-3">
                    <i class="fas fa-gamepad text-indigo-600 mr-2"></i>Select Game
                </label>
                <select name="game" id="gameSelect" required
                        class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-lg">
                    <option value="">Choose a game...</option>
                    {% for game in games %}
                    <option value="{{ game.id }}" 
                            data-opening="{{ game.opening_time }}" 
                            data-closing="{{ game.closing_time }}"
                            data-duration="{{ game.slot_duration_minutes }}">
                        {{ game.name }} ({{ game.get_booking_type_display }})
                    </option>
                    {% endfor %}
                </select>
                <p class="text-sm text-gray-600 mt-2">
                    <i class="fas fa-lightbulb mr-1"></i>
                    Only active games are shown
                </p>
            </div>

            <!-- Date Selection -->
            <div class="mb-8">
                <label class="block text-lg font-semibold text-gray-800 mb-3">
                    <i class="fas fa-calendar-alt text-indigo-600 mr-2"></i>Select Date(s)
                </label>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Start Date</label>
                        <input type="date" name="start_date" id="startDate" required min="{{ today }}"
                               class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">End Date (Optional)</label>
                        <input type="date" name="end_date" id="endDate" min="{{ today }}"
                               class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                        <p class="text-xs text-gray-500 mt-1">Leave empty for single day</p>
                    </div>
                </div>
            </div>

            <!-- Time Selection -->
            <div class="mb-8">
                <label class="block text-lg font-semibold text-gray-800 mb-3">
                    <i class="fas fa-clock text-indigo-600 mr-2"></i>Time Range
                </label>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Start Time</label>
                        <input type="time" name="start_time" id="startTime" required
                               class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">End Time</label>
                        <input type="time" name="end_time" id="endTime" required
                               class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    </div>
                </div>
            </div>

            <!-- Slot Duration -->
            <div class="mb-8">
                <label class="block text-lg font-semibold text-gray-800 mb-3">
                    <i class="fas fa-hourglass-half text-indigo-600 mr-2"></i>Slot Duration
                </label>
                <div class="flex items-center space-x-4">
                    <input type="number" name="slot_duration" id="slotDuration" value="60" min="15" max="480" step="15" required
                           class="w-32 px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-center text-lg font-semibold">
                    <span class="text-gray-700 font-medium">minutes per slot</span>
                </div>
                <p class="text-sm text-gray-600 mt-2">
                    <i class="fas fa-info-circle mr-1"></i>
                    Common durations: 30, 60, 90, or 120 minutes
                </p>
            </div>

            <!-- Preview Section -->
            <div id="previewSection" class="hidden mb-8 p-6 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-lg border-2 border-indigo-200">
                <h3 class="text-lg font-semibold text-indigo-900 mb-3">
                    <i class="fas fa-eye mr-2"></i>Preview
                </h3>
                <div id="previewContent" class="text-gray-700"></div>
            </div>

            <!-- Submit Buttons -->
            <div class="flex justify-between items-center pt-6 border-t-2 border-gray-200">
                <a href="{% url 'authentication:owner_overview' %}" 
                   class="px-6 py-3 border-2 border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 font-medium transition-colors duration-200">
                    <i class="fas fa-arrow-left mr-2"></i>Cancel
                </a>
                <button type="button" onclick="previewSlots()" 
                        class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors duration-200 mr-3">
                    <i class="fas fa-eye mr-2"></i>Preview Slots
                </button>
                <button type="submit" id="submitBtn"
                        class="px-8 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white rounded-lg font-medium transition-all duration-200 shadow-lg">
                    <i class="fas fa-plus-circle mr-2"></i>Create Custom Slots
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// Set minimum date to today
document.getElementById('startDate').min = '{{ today }}';
document.getElementById('endDate').min = '{{ today }}';

// Update slot duration when game is selected
document.getElementById('gameSelect').addEventListener('change', function() {
    const selected = this.options[this.selectedIndex];
    if (selected.value) {
        const duration = selected.dataset.duration;
        document.getElementById('slotDuration').value = duration;
    }
});

// Preview slots
function previewSlots() {
    const game = document.getElementById('gameSelect');
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value || startDate;
    const startTime = document.getElementById('startTime').value;
    const endTime = document.getElementById('endTime').value;
    const duration = parseInt(document.getElementById('slotDuration').value);
    
    if (!game.value || !startDate || !startTime || !endTime) {
        alert('Please fill all required fields');
        return;
    }
    
    // Calculate slots
    const start = new Date(`2000-01-01T${startTime}`);
    const end = new Date(`2000-01-01T${endTime}`);
    const diffMinutes = (end - start) / 60000;
    const slotsPerDay = Math.floor(diffMinutes / duration);
    
    // Calculate days
    const d1 = new Date(startDate);
    const d2 = new Date(endDate);
    const days = Math.floor((d2 - d1) / (1000 * 60 * 60 * 24)) + 1;
    
    const totalSlots = slotsPerDay * days;
    
    // Show preview
    const previewSection = document.getElementById('previewSection');
    const previewContent = document.getElementById('previewContent');
    
    let slotsHtml = '<div class="space-y-3">';
    slotsHtml += `<div class="flex items-center space-x-2">`;
    slotsHtml += `<i class="fas fa-calendar-check text-indigo-600"></i>`;
    slotsHtml += `<span class="font-semibold">Game:</span> <span>${game.options[game.selectedIndex].text}</span>`;
    slotsHtml += `</div>`;
    slotsHtml += `<div class="flex items-center space-x-2">`;
    slotsHtml += `<i class="fas fa-calendar-days text-indigo-600"></i>`;
    slotsHtml += `<span class="font-semibold">Dates:</span> <span>${startDate}${endDate !== startDate ? ' to ' + endDate : ''} (${days} day${days > 1 ? 's' : ''})</span>`;
    slotsHtml += `</div>`;
    slotsHtml += `<div class="flex items-center space-x-2">`;
    slotsHtml += `<i class="fas fa-clock text-indigo-600"></i>`;
    slotsHtml += `<span class="font-semibold">Time:</span> <span>${startTime} - ${endTime}</span>`;
    slotsHtml += `</div>`;
    slotsHtml += `<div class="flex items-center space-x-2">`;
    slotsHtml += `<i class="fas fa-hourglass text-indigo-600"></i>`;
    slotsHtml += `<span class="font-semibold">Duration:</span> <span>${duration} minutes per slot</span>`;
    slotsHtml += `</div>`;
    slotsHtml += `<div class="flex items-center space-x-2 pt-2 border-t border-indigo-200">`;
    slotsHtml += `<i class="fas fa-list-check text-green-600 text-xl"></i>`;
    slotsHtml += `<span class="font-bold text-lg text-green-700">Total Slots to Create: ${totalSlots}</span>`;
    slotsHtml += `</div>`;
    slotsHtml += `<div class="text-sm text-gray-600 mt-2">`;
    slotsHtml += `<i class="fas fa-info-circle mr-1"></i>${slotsPerDay} slots per day Ã— ${days} day${days > 1 ? 's' : ''}`;
    slotsHtml += `</div>`;
    slotsHtml += '</div>';
    
    previewContent.innerHTML = slotsHtml;
    previewSection.classList.remove('hidden');
    previewSection.scrollIntoView({ behavior: 'smooth' });
}

// Form validation
document.getElementById('customSlotForm').addEventListener('submit', function(e) {
    const endDate = document.getElementById('endDate').value;
    const startDate = document.getElementById('startDate').value;
    
    if (endDate && endDate < startDate) {
        e.preventDefault();
        alert('End date cannot be before start date');
        return false;
    }
    
    const startTime = document.getElementById('startTime').value;
    const endTime = document.getElementById('endTime').value;
    
    if (endTime <= startTime) {
        e.preventDefault();
        alert('End time must be after start time');
        return false;
    }
    
    // Show loading
    document.getElementById('submitBtn').innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Creating Slots...';
    document.getElementById('submitBtn').disabled = true;
});
</script>
{% endblock %}
